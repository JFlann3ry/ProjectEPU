{% extends "base.html" %}
{% from "components/macros.html" import page_hero, notice %}

{% block title %}Event Gallery - EPU{% endblock %}

{% block breadcrumbs %}
        {% from 'components/macros.html' import breadcrumbs %}
        <div class="breadcrumbs-container section" style="padding-bottom:0;">
            {% if event_id %}
                {{ breadcrumbs([{'label':'My Events','href':'/events'},{'label': event_name or 'Event','href':'/events/' ~ event_id}], 'Gallery') }}
            {% else %}
                {{ breadcrumbs([{'label':'My Events','href':'/events'}], 'Gallery') }}
            {% endif %}
        </div>
{% endblock %}
{% block content %}
        <div class="container section center">
                {{ page_hero('Event Gallery', 'Browse, favorite, and manage uploads.', True) }}

                {% if filters and filters.show_deleted %}
                    {{ notice('Files marked for deletion will be permanently removed after 30 days. You can restore them here until then.', 'error', 'style="margin: 8px 0 12px;"') }}
                {% endif %}
    <div class="card" style="margin-bottom:16px;">
            <style>
        .gallery-filters { padding: 10px 12px 8px; }
        .gallery-filters .filters-row { display:flex; flex-wrap: nowrap; align-items:center; gap:12px; }
        .gallery-filters .filter-group { display:flex; gap:12px; align-items:center; }
    .gallery-filters .pill-filter { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.26); background: rgba(255,255,255,0.10); color: var(--color-text); cursor: pointer; user-select: none; transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease; }
        .gallery-filters .pill-filter[aria-pressed="true"] { border-color: var(--color-primary); background: rgba(112, 97, 255, 0.22); box-shadow: inset 0 0 0 1px rgba(112,97,255,0.35); }
        .gallery-filters .pill-filter:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
    .gallery-filters .pill-filter .count { display:inline; margin-left: 6px; opacity: .85; text-align:center; font-variant-numeric: tabular-nums; transition: opacity .15s ease, transform .15s ease; }
    .gallery-filters .pill-filter[aria-pressed="true"] .count { opacity: 1; }
        .gallery-filters .spacer { flex: 1 1 auto; }
        @media (max-width: 760px){ .gallery-filters .filters-row { flex-wrap: wrap; } }

        /* Toolbar tweaks for better visual grouping */
        .gallery-toolbar { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-top:1px solid var(--color-border); }
        .gallery-toolbar .toolbar-left, .gallery-toolbar .toolbar-right { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }

    /* Delete confirm modal */
    #delete-confirm { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 1002; }
    #delete-confirm .modal-content { width: min(520px, 92vw); border-radius: 12px; border: 1px solid var(--color-border); background: rgba(0,0,0,0.8); padding: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.45); }
    #delete-confirm .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    /* Ordinal badge on tiles - place top-right above checkbox */
    .gallery-item { position: relative; }
    .tile-ordinal { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; font-size: 12px; line-height: 1; padding: 2px 6px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.4); z-index: 30; pointer-events: none; }
    /* Ensure select checkbox sits beneath ordinal (checkbox already in DOM near left) */
            </style>
            <div class="gallery-filters">
                <div class="filters-row">
                    <div class="filter-group" role="group" aria-label="Type filter">
                        <button type="button" class="pill-filter" data-filter="type" data-value="" aria-pressed="{{ 'true' if not filters or not filters.type else 'false' }}">All{% if counts %}<span class="count">{{ counts.all }}</span>{% endif %}</button>
                        <button type="button" class="pill-filter" data-filter="type" data-value="image" aria-pressed="{{ 'true' if filters and filters.type=='image' else 'false' }}">Images{% if counts %}<span class="count">{{ counts.images }}</span>{% endif %}</button>
                        <button type="button" class="pill-filter" data-filter="type" data-value="video" aria-pressed="{{ 'true' if filters and filters.type=='video' else 'false' }}">Videos{% if counts %}<span class="count">{{ counts.videos }}</span>{% endif %}</button>
                    </div>
                    <div class="filter-group" role="group" aria-label="Flags">
                        {% if has_deleted %}
                        <button type="button" class="pill-filter" data-filter="show_deleted" data-toggle="1" aria-pressed="{{ 'true' if filters and filters.show_deleted else 'false' }}">Show deleted{% if counts %}<span class="count">{{ counts.deleted }}</span>{% endif %}</button>
                        {% endif %}
                        <button type="button" class="pill-filter" data-filter="favorites" data-toggle="1" aria-pressed="{{ 'true' if filters and filters.favorites else 'false' }}">Favorites{% if counts %}<span class="count">{{ counts.favorites }}</span>{% endif %}</button>
                    </div>
                    <div class="spacer" aria-hidden="true"></div>
                    <div class="filter-group" style="margin-left:12px;">
                        <label for="album-filter" class="muted small" style="margin-right:8px;">Album</label>
                        <select id="album-filter" class="input-field" style="min-width:160px; padding:6px 8px; height:34px;">
                            <option value="">All albums</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="gallery-toolbar">
                <div class="toolbar-left">
                    <button id="play-slideshow" class="btn" type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" aria-hidden="true" style="vertical-align:middle; margin-right:6px;">
                            <path fill="currentColor" d="M8 5v14l11-7z"></path>
                        </svg>
                        Play Slideshow
                    </button>
                    <button id="new-album" class="btn" type="button">New Album</button>
                </div>
                <div class="toolbar-right">
                    <button id="select-all" type="button" class="btn" title="Select all visible">Select All</button>
                    {% if not (filters and filters.show_deleted) %}
                    <form id="delete-form" method="post" action="/gallery/actions/delete" style="display:none;">
                        <input type="hidden" name="file_ids" value="">
                        <button type="submit" class="btn danger" hidden>Delete</button>
                    </form>
                    {% endif %}
                    {% if has_deleted %}
                    <form id="restore-form" method="post" action="/gallery/actions/restore" style="display:none;">
                        <input type="hidden" name="file_ids" value="">
                        <button type="submit" class="btn success" disabled>Restore</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

    {% if files %}
    {% set sorted_files = files %}
    {% if filters and filters.show_deleted %}
        {# Sorted by days_left; backend now guarantees an int for deleted files (or 9999 for unknown) #}
        {% set sorted_files = files|sort(attribute='days_left') %}
    {% endif %}
    <div class="dynamic-gallery masonry-row-first" id="gallery" data-next-offset="{{ next_offset if next_offset is not none else '' }}" data-page-size="{{ page_size }}">
            {% if filters and filters.show_deleted %}{% set ns = namespace(last_days=None) %}{% endif %}
            {% for file in sorted_files %}
            {% set days = file.days_left if file.days_left is number else 9999 %}
            {% if filters and filters.show_deleted and days != ns.last_days %}
                <div class="group-heading" data-days="{{ days }}" aria-label="Group: {% if days >= 9999 %}Deletion date unknown{% elif days == 0 %}Deleting soon{% elif days == 1 %}1 day left{% else %}{{ days }} days left{% endif %}">
                    {% if days >= 9999 %}Deletion date unknown{% elif days == 0 %}Deleting soon{% elif days == 1 %}1 day left{% else %}{{ days }} days left{% endif %}
                </div>
                {% set ns.last_days = days %}
            {% endif %}
            {% if file.type == 'video' %}
                {% set cls = 'gallery-item gallery-large gallery-video-tile gallery-clickable' %}
                {% set row_span = 2 %}
            {% else %}
                {% set cls = 'gallery-item gallery-clickable' %}
                {% set row_span = [1,2] | random %}
            {% endif %}
            <div class="{{ cls }}" data-index="{{ loop.index0 }}" data-name="{{ file.name }}" data-datetime="{{ file.datetime or '' }}">
                <input type="checkbox" class="select-chk" data-id="{{ file.id }}">
                {% if file.type == 'image' %}
                    <img src="{{ file.thumb_url or file.url }}" data-full="{{ file.url }}" class="gallery-img" alt="{{ file.name }}" loading="lazy" {% if file.srcset %}srcset="{{ file.srcset }}" sizes="(max-width: 640px) 45vw, (max-width: 1024px) 30vw, 20vw"{% endif %}>
                {% elif file.type == 'video' %}
                    <video src="{{ file.url }}" class="gallery-video" controls preload="none" {% if file.thumb_url %}poster="{{ file.thumb_url }}"{% endif %}></video>
                {% endif %}
                <div class="tile-overlay"></div>
                {% if file.type == 'video' %}
                    <div class="tile-badge video" title="Video">▶</div>
                {% endif %}
                {% if file.deleted %}
                    {# In deleted view, remove per-tile countdown chip; rely on group headings only #}
                    {% if not (filters and filters.show_deleted) %}
                        <div class="tile-badge deleted" title="Deleted">Deleted</div>
                    {% endif %}
                {% endif %}
                {% if file.favorite %}
                    <button class="fav-btn is-fav" title="Unfavorite" data-id="{{ file.id }}">★</button>
                {% else %}
                    <button class="fav-btn" title="Favorite" data-id="{{ file.id }}">☆</button>
                {% endif %}
                {# Ordinal badge (small persistent corner) #}
                {% if file.ordinal is defined %}
                    <div class="tile-ordinal" aria-hidden="true">{{ file.ordinal }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
            <div class="p-bold">No files found.</div>
        {% endif %}
    <div id="gallery-loader" class="center muted" style="padding:12px; display: none;">Loading more…</div>
    <div id="gallery-end" class="center muted text-center" style="padding:12px; display:none;">End of uploads.</div>
    </div>
    <div id="bulk-bar" class="bulk-bar" style="display:none;">
        <div class="bulk-inner">
            <span id="bulk-count">0 selected</span>
            <div class="bulk-actions">
                <button id="bb-clear" type="button" class="btn">Clear</button>
                {% if not (filters and filters.show_deleted) %}
                <button id="bb-delete" type="button" class="btn danger" disabled>Delete</button>
                {% endif %}
                {% if has_deleted %}<button id="bb-restore" type="button" class="btn success" disabled>Restore</button>{% endif %}
                <button id="bb-zip" type="button" class="btn primary" disabled>Download ZIP</button>
                <button id="bb-add-to-album" type="button" class="btn" disabled>Add to album</button>
            </div>
        </div>
    </div>
    <!-- Create Album Modal (fallback; primary UI uses shared modal root) -->
    <div id="create-album-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;">
        <div class="modal-content" role="document" style="max-width:480px; margin: 0 auto; padding:16px;">
            <h3 class="p-bold">Create album</h3>
            <form id="create-album-form">
                <div style="margin-top:8px;">
                    <label for="create-album-name">Album name</label>
                    <input id="create-album-name" name="name" class="input-field" required maxlength="255">
                </div>
                <div style="margin-top:8px;">
                    <label for="create-album-desc">Description (optional)</label>
                    <textarea id="create-album-desc" name="description" class="input-field" rows="3" maxlength="1024"></textarea>
                </div>
                <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                    <button type="button" id="create-album-cancel" class="btn">Cancel</button>
                    <button type="submit" id="create-album-submit" class="btn primary">Create</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Delete confirmation modal -->
    {% if not (filters and filters.show_deleted) %}
    <div id="delete-confirm" role="dialog" aria-modal="true" aria-labelledby="del-title" style="display:none;">
        <div class="modal-content">
            <h3 id="del-title" class="p-bold" style="margin:0 0 6px;">Delete selected files?</h3>
            <div class="muted" id="del-msg">These files will be marked for deletion and permanently removed after 30 days. You can restore them from the Deleted view within that time.</div>
            <div class="modal-actions">
                <button type="button" id="del-cancel" class="btn">Cancel</button>
                <button type="button" id="del-confirm" class="btn danger">Delete</button>
            </div>
        </div>
    </div>
    {% endif %}
    <div id="lightbox" class="lightbox" style="display:none;">
        <span id="lightbox-close" class="lightbox-close" role="button" tabindex="0" aria-label="Close">&times;</span>
        <div class="lightbox-content">
            <span id="lightbox-prev" class="lightbox-prev" role="button" tabindex="0" aria-label="Previous">&#10094;</span>
            <span id="lightbox-next" class="lightbox-next" role="button" tabindex="0" aria-label="Next">&#10095;</span>
            <img id="lightbox-img" alt="" style="display:none;max-width:90vw;max-height:80vh;">
            <video id="lightbox-video" style="display:none;max-width:90vw;max-height:80vh;" controls></video>
        </div>
    </div>
{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='gallery.css') }}">
{% endblock %}
{% block extra_js %}
{% set data_files = files %}
{% if filters and filters.show_deleted %}
    {% set data_files = files|sort(attribute='days_left') %}
{% endif %}
<script id="gallery-data" type="application/json">{{ ({'event_id': event_id, 'files': data_files, 'show_deleted': (1 if filters and filters.show_deleted else 0)}) | tojson | safe }}</script>
<script>
// Populate album selector for this event and wire change handler
(function(){
    try{
        var metaEl = document.getElementById('gallery-data');
        if(!metaEl) return;
        var meta = {};
        try{ meta = JSON.parse(metaEl.textContent || '{}'); }catch(e){}
        var eventId = meta.event_id || null;
        if(!eventId) return;
        var sel = document.getElementById('album-filter');
        if(!sel) return;
        fetch('/events/' + encodeURIComponent(eventId) + '/albums')
            .then(function(r){ if(!r.ok) return null; return r.json(); })
            .then(function(j){
                if(!j || !Array.isArray(j.items)) return null;
                j.items.forEach(function(a){
                    try{
                        var opt = document.createElement('option');
                        opt.value = a.id;
                        opt.textContent = a.name + (a.count ? (' (' + a.count + ')') : '');
                        sel.appendChild(opt);
                    }catch(e){}
                });
                try{
                    var u = new URL(window.location.href);
                    return u.searchParams.get('album_id');
                }catch(e){ return null; }
            })
            .then(function(cur){ if(cur) sel.value = cur; })
            .catch(function(){ /* ignore */ })
            .finally(function(){ try{ if (eventId && typeof applyServerOrder === 'function') applyServerOrder(eventId); }catch(e){} });
        sel.addEventListener('change', function(){
            var v = sel.value;
            var u = new URL(window.location.href);
            if(v) u.searchParams.set('album_id', v);
            else u.searchParams.delete('album_id');
            window.location.href = u.toString();
        });
    }catch(e){ }
})();
</script>
<script type="module" src="{{ url_for('static', path='js/pages/gallery.js') }}?v={{ now() if now else '' }}" defer></script>
{% endblock %}
