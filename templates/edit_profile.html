{% extends "base.html" %}
{% from "components/macros.html" import page_hero %}

{% block title %}Edit Profile - EPU{% endblock %}

{% block breadcrumbs %}
<div class="container section profile-page center" style="padding-bottom:0;">
    {% from 'components/macros.html' import breadcrumbs %}
    {{ breadcrumbs([{'label':'Profile','href':'/profile'}], 'Edit') }}
    </div>
{% endblock %}
{% block content %}
<div class="container section profile-page center">
    {{ page_hero('Edit Profile', 'Update your details, manage emails, and export your data.', True) }}

    <style>
        /* Consistent card inner width and alignment */
        .profile-page .card-body { max-width: 560px; margin: 0 auto; padding: 16px 20px; text-align: left; }
        .profile-page .h4 { margin: 0 0 8px; }
        .profile-page .btn-row { display: flex; gap: 10px; align-items: center; }
        /* Shared small layout helpers */
        .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }
        .row-inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .muted { opacity:.9; }
        .form .floating-field { margin-bottom: 10px; }
    </style>

        {% from 'components/macros.html' import notice, btn_row %}
        {% if error %}
            {{ notice(error, kind='error', attrs='style="max-width:800px;margin:0 auto 12px;"') }}
        {% endif %}
        {% if message %}
            {{ notice(message, kind='success', attrs='style="max-width:800px;margin:0 auto 12px;"') }}
        {% endif %}

    <!-- Profile details -->
    <div class="card" style="max-width:800px;margin:0 auto 16px;">
        <div class="card-body">
            <form class="form" method="post" action="/profile/edit">
                <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}" />
                <style>
                    /* Email prefs UI bits used later */
                    .prefs-box { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 12px; }
                    .prefs-list { display: grid; gap: 8px; }
                    .checkbox-row { display:flex; align-items:center; gap: 10px; }
                    .checkbox-row span { display:inline-block; }
                    .prefs-meta { display:flex; justify-content: space-between; align-items:center; margin-top: 8px; gap: 10px; }
                    .prefs-meta .muted { font-size: .95rem; }
                    .prefs-actions { display:flex; justify-content:flex-end; }
                    .btn.primary.compact { padding: 8px 12px; font-size: .95rem; }
                    .prefs-box legend { display:none; }
                </style>
                <div class="grid-2">
                    <div class="floating-field">
                        <label for="first_name" class="fl-label">First name</label>
                        <input class="input-field" type="text" id="first_name" name="first_name" value="{{ user.FirstName }}" required autocomplete="given-name">
                    </div>
                    <div class="floating-field">
                        <label for="last_name" class="fl-label">Last name</label>
                        <input class="input-field" type="text" id="last_name" name="last_name" value="{{ user.LastName }}" required autocomplete="family-name">
                    </div>
                </div>
                <div class="floating-field" style="margin-top:8px;">
                    <label for="email" class="fl-label">Email</label>
                    <input class="input-field" type="email" id="email" value="{{ user.Email }}" autocomplete="email" readonly disabled title="Email cannot be changed">
                </div>
                {% call btn_row('style="margin-top:12px;"') %}
                    <button type="submit" class="btn primary">Save changes</button>
                    <a class="btn" href="/profile/password">Change password</a>
                {% endcall %}
            </form>
        </div>
    </div>

    <!-- Email preferences -->
    <div class="card" style="max-width:800px;margin:0 auto 16px;">
        <div class="card-body">
            <h3 class="h4" id="email-prefs-heading">Email preferences</h3>
            <p class="muted" style="margin:0 0 10px;">Choose which emails you&rsquo;d like to receive.</p>
            <form id="email-prefs-form" method="post" action="/profile/email-preferences" class="form" style="margin:0 0 10px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}" />
                <div class="prefs-box" role="group" aria-labelledby="email-prefs-heading">
                <style>
                    /* Ensure strong readable text inside the box */
                    .prefs-box { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.18); color: var(--text-strong, #e8e8ea); }
                    .prefs-box .checkbox-row span { color: var(--text-strong, #e8e8ea); font-weight: 500; }
                    .prefs-box .checkbox-field { transform: translateY(1px); }
                    .prefs-box .btn { box-shadow: none; }
                </style>
                <div id="prefs-help" class="muted" style="margin-bottom:6px;">Tick to opt in. You can change these anytime.</div>
                <div class="prefs-list">
                    <label class="checkbox-row">
                        <input class="checkbox-field" type="checkbox" name="marketing" value="1" {% if email_prefs and email_prefs.marketing %}checked{% endif %} />
                        <span>Marketing emails (occasional offers and tips)</span>
                    </label>
                    <label class="checkbox-row">
                        <input class="checkbox-field" type="checkbox" name="product" value="1" {% if email_prefs and email_prefs.product %}checked{% endif %} />
                        <span>Product updates (new features and improvements)</span>
                    </label>
                    <label class="checkbox-row">
                        <input class="checkbox-field" type="checkbox" name="reminders" value="1" {% if email_prefs and email_prefs.reminders %}checked{% endif %} />
                        <span>Event reminders and notifications</span>
                    </label>
                </div>
                <div class="prefs-meta">
                    <div>
                        <div id="prefs-status" class="muted" aria-live="polite" style="min-height:18px;"></div>
                    </div>
                    <div class="prefs-actions" style="gap:8px;">
                        <button id="prefs-save" class="btn primary compact" type="submit" disabled>Save preferences</button>
                        <button id="prefs-unsub" class="btn danger compact" type="button">Unsubscribe from all</button>
                    </div>
                </div>
                </div>
            </form>
        </div>

    <!-- Data export -->
    <div class="card" style="max-width:800px;margin:0 auto 16px;">
        <div class="card-body">
            <h3 class="h4">Data export</h3>
            <p class="muted" style="margin:0 0 10px;">Request a copy of your data as a downloadable ZIP.</p>
            <form id="export-form" method="post" action="/profile/export/request" class="form" style="margin:0;" data-cooldown-seconds="{{ export_cooldown_seconds or 0 }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}" />
                <div class="prefs-box" style="padding:12px;">
                <div class="row-inline" style="justify-content:space-between; gap:10px; align-items:center;">
                    <div>
                        {% if export_job and export_job.Status == 'completed' %}
                            <div class="muted">Generated: <strong>{{ export_job.CompletedAt.strftime('%Y-%m-%d %H:%M UTC') if export_job.CompletedAt }}</strong></div>
                            {% if export_expired %}
                                <div class="muted" style="color:#ffb454;">Expired. Please request a new export.</div>
                            {% else %}
                                <div class="muted">Expires: {{ export_job.ExpiresAt.strftime('%Y-%m-%d %H:%M UTC') if export_job.ExpiresAt }}</div>
                            {% endif %}
                        {% elif export_job and export_job.Status in ['queued','running'] %}
                            <div class="muted">Your export is being prepared. This may take a minute.</div>
                        {% else %}
                            <div class="muted">No export generated yet.</div>
                        {% endif %}
                    </div>
                    <div class="row-inline" style="gap:8px;">
                        {% if export_ready %}
                            <a id="btn-download-export" class="btn primary" href="/profile/export/download">Download ZIP</a>
                        {% endif %}
                        {% set cooldown = export_cooldown_seconds or 0 %}
                        <button id="btn-request-export" type="submit" class="btn" {% if cooldown > 0 %}disabled{% endif %}>
                            {% if cooldown > 0 %}Request export (cooldown){% else %}Request export{% endif %}
                        </button>
                    </div>
                </div>
                {% if export_job and export_job.Status == 'failed' %}
                    <div class="muted" style="margin-top:6px;color:#ff6b6b;">Export failed. Please try again or contact support.</div>
                {% endif %}
                {% if cooldown > 0 %}
                    <div id="export-cooldown" class="muted" aria-live="polite" style="margin-top:6px;">You can request another export in <span id="cooldown-timer"></span>.</div>
                {% endif %}
                    <div class="muted" style="margin-top:6px;">Need help? <a href="/contact?topic=Data%20export">Contact support</a>.</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Danger zone -->
    <div class="card" style="max-width:800px;margin:0 auto;">
        <div class="card-body">
            <h3 class="h4">Danger zone</h3>
            <p class="muted" style="margin:0 0 10px;">Permanently delete your account and all associated data. This action cannot be undone.</p>
            <button type="button" class="btn danger" id="btn-delete-account">Delete account</button>
        </div>
    </div>
</div>
{% block extra_js %}
<script>
(function(){
    // Ensure an ARIA live region exists for status updates
    (function(){
        var lr = document.getElementById('aria-live-toast');
        if (!lr) {
            lr = document.createElement('div');
            lr.id = 'aria-live-toast';
            lr.setAttribute('aria-live', 'polite');
            lr.setAttribute('aria-atomic', 'true');
            lr.style.position = 'absolute';
            lr.style.width = '1px';
            lr.style.height = '1px';
            lr.style.margin = '-1px';
            lr.style.border = '0';
            lr.style.padding = '0';
            lr.style.clip = 'rect(0 0 0 0)';
            lr.style.overflow = 'hidden';
            document.body.appendChild(lr);
        }
    })();
    const liveRegion = document.getElementById('aria-live-toast');
    const delBtn = document.getElementById('btn-delete-account');
    if (!delBtn) return;
    delBtn.addEventListener('click', function(){
        if (window.EPU && window.EPU.modal) {
            window.EPU.modal.show({
                title: 'Delete account?',
                body: '<div class="preview-body"><p>This will permanently delete your account and data. This cannot be undone.</p></div>',
                actions: [
                    { label: 'Cancel', role: 'cancel' },
                    { label: 'Delete account', danger: true, onClick: function(){ window.location.href = '/account/delete'; } }
                ]
            });
        } else if (confirm('This will permanently delete your account and data. Continue?')) {
            window.location.href = '/account/delete';
        }
    });
    // Email prefs UX: live summary, enable save on change, confirm unsubscribe
    const prefsForm = document.getElementById('email-prefs-form');
    const saveBtn = document.getElementById('prefs-save');
    const statusEl = document.getElementById('prefs-status');
    const unsubBtn = document.getElementById('prefs-unsub');
    const csrfInput = prefsForm ? prefsForm.querySelector('input[name="csrf_token"]') : null;

    function setSaveEnabled(enabled) {
        if (!saveBtn) return;
        saveBtn.disabled = !enabled;
    }
    function setStatus(msg, type) {
        if (!statusEl) return;
        statusEl.textContent = msg || '';
        statusEl.style.color = type === 'error' ? '#ff6b6b' : 'var(--text-strong, #e8e8ea)';
        if (liveRegion) liveRegion.textContent = msg || '';
    }
    async function postFormData(url, formData) {
        // Let fetch follow redirects; we just care about ok/not ok
        const res = await fetch(url, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        });
        // Treat 2xx and 3xx as success since server may redirect after save
        if (res.ok || (res.status >= 300 && res.status < 400)) {
            return true;
        }
        return false;
    }
    // Track pristine state
    let original = '';
    if (prefsForm) {
        original = Array.from(prefsForm.querySelectorAll('input[type="checkbox"]')).map(b => (b.name+':'+(b.checked?'1':'0'))).join('|');
        setSaveEnabled(false);
        prefsForm.addEventListener('change', () => {
            const current = Array.from(prefsForm.querySelectorAll('input[type="checkbox"]')).map(b => (b.name+':'+(b.checked?'1':'0'))).join('|');
            setSaveEnabled(current !== original);
        });
        prefsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!saveBtn) return;
            setStatus('Saving…');
            saveBtn.disabled = true;
            const fd = new FormData(prefsForm);
            // Ensure unchecked boxes are sent as 0 so backend can clear them if required
            ['marketing','product','reminders'].forEach(name => {
                if (!fd.has(name)) fd.append(name, '0');
            });
            const ok = await postFormData(prefsForm.action, fd).catch(() => false);
            if (ok) {
                setStatus('Preferences saved');
                original = Array.from(prefsForm.querySelectorAll('input[type="checkbox"]')).map(b => (b.name+':'+(b.checked?'1':'0'))).join('|');
                setSaveEnabled(false);
            } else {
                setStatus('Save failed. Please try again.', 'error');
                setSaveEnabled(true);
            }
        });
    }
    if (unsubBtn && prefsForm) {
        unsubBtn.addEventListener('click', async () => {
            const msg = 'Are you sure you want to unsubscribe from all emails? You can re-subscribe later.';
            const proceed = (window.EPU && window.EPU.modal)
                ? await new Promise((resolve) => {
                    window.EPU.modal.show({
                        title: 'Unsubscribe from all?',
                        body: '<div class="preview-body"><p>'+msg+'</p></div>',
                        actions: [
                            { label: 'Cancel', role: 'cancel', onClick: () => resolve(false) },
                            { label: 'Unsubscribe', danger: true, onClick: () => resolve(true) }
                        ]
                    });
                })
                : confirm(msg);
            if (!proceed) return;
            setStatus('Unsubscribing…');
            unsubBtn.disabled = true;
            const fd = new FormData();
            if (csrfInput) fd.append('csrf_token', csrfInput.value);
            const ok = await postFormData('/profile/email-preferences/unsubscribe', fd).catch(() => false);
            if (ok) {
                // Uncheck all locally
                prefsForm.querySelectorAll('input[type="checkbox"]').forEach(b => { b.checked = false; });
                original = Array.from(prefsForm.querySelectorAll('input[type="checkbox"]')).map(b => (b.name+':0')).join('|');
                setSaveEnabled(false);
                setStatus('You have been unsubscribed from all emails');
            } else {
                setStatus('Unsubscribe failed. Please try again.', 'error');
            }
            unsubBtn.disabled = false;
        });
    }
    // Export cooldown countdown and AJAX-ish UX
    const exportForm = document.getElementById('export-form');
    const requestBtn = document.getElementById('btn-request-export');
    const cooldownWrap = document.getElementById('export-cooldown');
    const cooldownTimer = document.getElementById('cooldown-timer');
    const cdAttr = exportForm ? exportForm.getAttribute('data-cooldown-seconds') : '0';
    let remaining = parseInt(cdAttr || '0', 10) || 0;
    function tickCooldown(){
        if (!cooldownTimer) return;
        if (remaining <= 0){ cooldownWrap && (cooldownWrap.style.display='none'); requestBtn && (requestBtn.disabled=false); return; }
        const h = Math.floor(remaining/3600);
        const m = Math.floor((remaining%3600)/60);
        const s = remaining%60;
        const parts = [];
        if (h>0) parts.push(h+'h'); if (m>0) parts.push(m+'m'); parts.push(s+'s');
        cooldownTimer.textContent = parts.join(' ');
        remaining -= 1;
        setTimeout(tickCooldown, 1000);
    }
    if (remaining > 0) tickCooldown();
    if (exportForm && requestBtn){
        exportForm.addEventListener('submit', function(e){
            // We let the form submit normally (server builds and redirects with message), but add quick UX
            requestBtn.disabled = true; requestBtn.textContent = 'Requesting…';
        });
    }
})();
</script>
{% endblock %}
{% endblock %}
