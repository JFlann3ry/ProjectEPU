{% extends "base.html" %}
{% from "components/macros.html" import page_hero %}

{% block title %}My Events - EPU{% endblock %}

{% block breadcrumbs %}
{% from 'components/macros.html' import breadcrumbs %}
<div class="breadcrumbs-container section" style="padding-bottom:0;">
    {{ breadcrumbs([{'label':'Profile','href':'/profile'}], 'My Events') }}
</div>
{% endblock %}

{% block content %}
<div class="container section center">
    {%- set events_msg = '' -%}
    {%- if total_events is none -%}
        {%- set events_msg = '' -%}
    {%- elif total_events == 0 -%}
        {%- set events_msg = 'You have no events.' -%}
    {%- elif total_events == 1 -%}
        {%- set events_msg = 'You have 1 event.' -%}
    {%- else -%}
        {%- set events_msg = 'You have ' ~ total_events ~ ' events.' -%}
    {%- endif -%}
    {{ page_hero('My Events', events_msg, False) }}

    {% if not plan %}
        <div class="notice" style="margin:12px 0 18px; border-style: dashed;">
            No active package. <a href="/pricing">Choose a package</a> to get started.
        </div>
    {% endif %}

    {% if events and events|length > 0 %}
    <div class="events-grid-wrap" style="display:flex; flex-wrap:wrap; justify-content:center; gap:12px;">
                                        {% for e in events %}
                                        {% set etname = (e.EventTypeName or '') %}
                                        {% set etkey = etname|lower %}
                                        {% set etmap = {
                                            'wedding':'üíç', 'birthday':'üéÇ', 'party':'ü•≥', 'corporate':'üíº', 'conference':'üó£Ô∏è', 'sports':'üèüÔ∏è',
                                            'holiday':'üéÑ', 'baby shower':'ü§±', 'graduation':'üéì', 'concert':'ÔøΩ', 'festival':'üé™', 'engagement':'üíû', 'funeral':'üïäÔ∏è'
                                        } %}
                                        {% set etemoji = etmap.get(etkey, 'üì∑') %}
                                        {% set etimgmap = {
                                            'wedding':'/static/images/examples/wedding1.svg',
                                            'corporate':'/static/images/examples/corporate1.svg',
                                            'school':'/static/images/examples/school1.svg'
                                        } %}
                                        {% set etimg = etimgmap.get(etkey, '/static/images/examples/corporate1.svg') %}
                    <div class="card full-height event-card v5">
                        <!-- Cover banner -->
                        <div class="cover" style="position:relative; overflow:hidden; padding-right:6px;">
                            <div class="title-row" style="position:relative; display:flex; justify-content:space-between; align-items:stretch; gap:12px;">
                                <div class="title-left" style="display:flex; flex-direction:column; align-items:flex-start; gap:4px; flex:1 1 auto; min-width:0;">
                                    <h3 class="event-title" title="{{ e.Name }}">{{ e.Name }}</h3>
                                    <div class="status-pills published">
                                        {% if e.Published %}
                                            <span class="pill success" title="Publicly accessible">Published</span>
                                        {% else %}
                                            <span class="pill warn" title="Not published">Unpublished</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                            </div>
                        </div>

                        <!-- Body with date card and interactive metrics -->
                        <div class="body">
                            <div class="row top" style="grid-template-columns: 100px 1fr;">
                                <div class="date-card" title="Event date">
                                    <div class="date-top">
                                        <svg class="icn calendar-mini" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                            <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/>
                                            <path d="M3 9h18" stroke="currentColor" stroke-width="1.5"/>
                                            <path d="M8 3v4M16 3v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                        {% if e.Date %}
                                            {% set mon = e.Date.strftime('%b') %}
                                            <span class="mon">{{ mon }}</span>
                                        {% else %}
                                            <span class="mon">‚Äî</span>
                                        {% endif %}
                                    </div>
                    {% if e.Date %}
                    {% set dayn = e.Date.day %}
                    <div class="date-day">{{ '%02d' % dayn }}<sup style="font-size:0.55em; vertical-align:super; margin-left:1px;">{{ dayn|ordsuffix }}</sup></div>
                                        <div class="date-foot" data-date="{{ e.Date.isoformat() }}">Calculating‚Ä¶</div>
                                    {% else %}
                                        <div class="date-day">‚Äî</div>
                                        <div class="date-foot">No date</div>
                                    {% endif %}
                                </div>
                <div class="thumb" aria-label="Event photo" style="width:100%; height:100%; min-height:120px; border-radius:12px; border:1px solid var(--color-border); background:#0f1322; overflow:hidden; display:flex; align-items:center; justify-content:center; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);">
                    <div aria-hidden="true" style="width:100%; height:100%; background-image:url('{{ e.CoverPhotoPath if e.CoverPhotoPath else etimg }}'); background-size:cover; background-position:center;"></div>
                </div>
                            </div>

                            {% set show_storage = features.max_storage_per_event_mb and e.StorageUsageMB is not none and features.max_storage_per_event_mb > 0 %}
                            {% set show_guests = features.max_guests_per_event and e.GuestCount is defined and features.max_guests_per_event > 0 %}
                            {% if show_storage or show_guests %}
                            <div class="metrics v5">
                                {% if show_storage %}
                                    {% set s_limit = features.max_storage_per_event_mb %}
                                    {% set s_used = e.StorageUsageMB %}
                                    {% set s_ratio = (s_used / s_limit) if s_limit > 0 else 0 %}
                                    {% set s_pct = (s_ratio * 100) | round(0, 'floor') %}
                                    <div class="metric">
                                        <div class="m-head">
                                            <div class="m-label">Storage</div>
                                            <div class="m-value">{{ s_used }}MB / {{ s_limit }}MB</div>
                                        </div>
                                        <div class="progress" data-pct="{{ s_pct }}" data-state="{% if s_ratio >= 1 %}danger{% elif s_ratio >= 0.9 %}warn{% else %}ok{% endif %}" aria-label="Storage used" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ s_pct }}">
                                            <div class="bar"></div>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if show_guests %}
                                    {% set limit = features.max_guests_per_event %}
                                    {% set used = e.GuestCount %}
                                    {% set ratio = (used / limit) if limit > 0 else 0 %}
                                    {% set pct = (ratio * 100) | round(0, 'floor') %}
                                    <div class="metric">
                                        <div class="m-head">
                                            <div class="m-label">Guests</div>
                                            <div class="m-value">{{ used }}/{{ limit }}</div>
                                        </div>
                                        <div class="progress" data-pct="{{ pct }}" data-state="{% if ratio >= 1 %}danger{% elif ratio >= 0.9 %}warn{% else %}ok{% endif %}" aria-label="Guests used" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ pct }}">
                                            <div class="bar"></div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Compact To‚ÄëDo section -->
                            <div class="setup v5" style="max-width: 320px;">
                                <div class="small muted" style="margin-bottom:6px;">To‚ÄëDo</div>
                                <a class="task {% if e.Date %}done{% else %}pending{% endif %}" href="/e/{{ e.Code }}/edit" title="Set or update event date">
                                    <svg class="ck" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span class="label">Set event date</span>
                                </a>
                                {% if e.Published %}
                                <div class="task done">
                                    <svg class="ck" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span class="label">Publish event</span>
                                </div>
                                {% else %}
                                <a class="task pending" href="/events/code/{{ e.Code }}" title="Open event to publish (Lock date)">
                                    <svg class="ck" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span class="label">Publish event</span>
                                </a>
                                {% endif %}
                                <a class="task {% if e.SharedOnce %}done{% else %}pending{% endif %} share-btn" href="/e/{{ e.Code }}" data-event-id="{{ e.EventID }}" data-code="{{ e.Code }}" data-published="{{ 1 if e.Published else 0 }}" data-title="{{ e.Name }}" data-share-template="Join %TITLE% ‚Äî %URL%" title="Share options">
                                    <svg class="ck" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span class="label">Share event</span>
                                </a>
                                    <a class="task {% if e.Task_purchase_extras %}done{% else %}pending{% endif %} js-task-toggle" href="/extras?event_code={{ e.Code }}" title="Purchase extras" data-task-key="purchase_extras" data-event-id="{{ e.EventID }}">
                                        <svg class="ck" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2v6M12 22v-6M2 12h6M22 12h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                        <span class="label">Purchase Extras</span>
                                    </a>
                                <a class="task {% if e.StorageUsageMB and e.StorageUsageMB > 0 %}done{% else %}pending{% endif %}" href="/guest/upload/{{ e.Code }}" title="Open guest upload page">
                                    <svg class="ck" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span class="label">Upload first photos</span>
                                </a>
                            </div>

                            <div class="spacer"></div>
                            {% from 'components/macros.html' import btn_row %}
                            {% call btn_row('class="actions" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"') %}
                                <a class="btn" href="/events/code/{{ e.Code }}" title="Manage event" style="width:100%; justify-content:center;">
                                    <svg class="icn" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M4 4v7M4 17v3M12 4v4M12 12v8M20 4v9M20 17v3M1 11h6M9 8h6M17 16h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>Manage</span>
                                </a>
                                    <button type="button" class="btn gallery-btn" data-gallery-select data-event-id="{{ e.EventID }}" title="Open gallery" style="width:100%; justify-content:center;">
                                        <svg class="icn" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M7 14l3-3 3 3 3-3 3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="9" r="1.5" fill="currentColor"/></svg>
                                        <span>Gallery</span>
                                    </button>
                            {% endcall %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
    {% else %}
        <div class="card" style="padding:22px; text-align:center;">
            <h3 style="margin-top:0;">No events yet</h3>
            <p class="muted">Create your first event to share a guest upload link and gallery.</p>
            <a class="btn primary" href="/events/create">Create Event</a>
        </div>
    {% endif %}
</div>
{% endblock %}
{% block extra_js %}
<script>
    (function(){
        // Handle Gallery open without form wrappers
        document.addEventListener('click', async function(e){
            var gb = e.target.closest('[data-gallery-select]');
            if (gb){
                e.preventDefault();
                var eid = gb.getAttribute('data-event-id');
                if (!eid) return;
                try {
                    var res = await fetch('/gallery/select', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' },
                        body: 'event_id=' + encodeURIComponent(eid)
                    });
                    if (res.ok) { window.location.href = '/gallery'; }
                    else { if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show('Failed to open gallery'); }
                } catch(err){ if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show('Network error'); }
            }
        });
        function esc(s){ return (s||'').replace(/[&<>"];/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',';':'&#59;'}[c]) || c; }); }
        function openShare(code, published, title, eid, tmpl){
            if (window.EPU && window.EPU.share && window.EPU.share.open){
                window.EPU.share.open({ code: code, published: !!published, title: title || '', tmpl: tmpl || null, eid: eid || null });
            }
        }

        // Listen for the shared event emitted by the global share modal and mark the event as shared server-side
        document.addEventListener('epu:shared', function(ev){
            try{ var eid = ev && ev.detail && ev.detail.eid; if (eid) { markShared(eid); } }catch(_e){}
        });
        async function copyToClipboard(text){
            try { if (navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(text); return true; } } catch(e){}
            try { var ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; } catch(e){ return false; }
        }
        function markSharedUI(eid){
            if (!eid) return;
            // Flip share to-do to done for this event card
            document.querySelectorAll('.event-card.v5 [data-event-id="' + eid + '"]').forEach(function(el){
                if (el.classList.contains('share-btn')){
                    el.classList.remove('pending');
                    el.classList.add('done');
                }
            });
        }
        async function markShared(eid){
            try { if (eid) { await fetch('/events/' + eid + '/mark-shared', { method: 'POST', headers: { 'X-Requested-With':'fetch' } }); } } catch(err){}
            markSharedUI(eid);
        }
        document.addEventListener('click', function(e){
            var copyBtn = e.target.closest('.share-copy');
            if (copyBtn){
                var u = copyBtn.getAttribute('data-url');
                var eid2 = copyBtn.getAttribute('data-eid');
                copyToClipboard(u).then(function(ok){
                    if (window.EPU && window.EPU.snackbar){ window.EPU.snackbar.show(ok?'Link copied':'Copy failed'); }
                    if (ok) { markShared(eid2); }
                });
                return;
            }
            var shareVia = e.target.closest('.share-via');
            if (shareVia){
                // Treat clicking an external share link as a share action
                var eid3 = shareVia.getAttribute('data-eid');
                markShared(eid3);
                return;
            }
            var shareMore = e.target.closest('.share-more');
            if (shareMore){
                e.preventDefault();
                var u = shareMore.getAttribute('data-url');
                var eid4 = shareMore.getAttribute('data-eid');
                if (navigator.share){
                    try {
                        navigator.share({ title: document.title || 'Event', text: 'Check out this event', url: u })
                        .then(function(){ if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show('Shared'); markShared(eid4); })
                        .catch(function(err){ if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show('Share cancelled'); });
                    } catch(err){
                        // If share throws synchronously, fallback to copy
                        copyToClipboard(u).then(function(ok){ if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show(ok?'Link copied':'Copy failed'); if (ok) markShared(eid4); });
                    }
                } else {
                    // Fallback: copy link
                    copyToClipboard(u).then(function(ok){ if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show(ok?'Link copied to clipboard':'Copy failed'); if (ok) markShared(eid4); });
                }
                return;
            }
        });

            // Hydrate progress bars (v5)
            function hydrateProgress(){
                document.querySelectorAll('.event-card.v5 .progress').forEach(function(p){
                    var pct = parseInt(p.getAttribute('data-pct') || '0', 10);
                    var state = (p.getAttribute('data-state') || 'ok').toLowerCase();
                    var bar = p.querySelector('.bar');
                    if(!bar) return;
                    bar.classList.remove('warn','danger');
                    if(state === 'warn') bar.classList.add('warn');
                    if(state === 'danger') bar.classList.add('danger');
                    requestAnimationFrame(function(){ bar.style.width = Math.max(0, Math.min(100, pct)) + '%'; });
                });
            }
            hydrateProgress();

            // Countdown footer inside date card
            function hydrateCountdown(){
                var now = new Date();
                document.querySelectorAll('.event-card.v5 .date-foot[data-date]').forEach(function(el){
                    var iso = el.getAttribute('data-date');
                    if(!iso) return;
                    var dt = new Date(iso);
                    if(isNaN(dt)) return;
                    var diffMs = dt.setHours(0,0,0,0) - (new Date(now)).setHours(0,0,0,0);
                    var days = Math.round(diffMs / 86400000);
                    if (days > 0){
                        el.textContent = days + ' days';
                        el.title = days + ' day' + (days===1?'':'s') + ' to go';
                    } else if (days === 0){
                        el.textContent = 'Today';
                        el.title = 'Event is today';
                    } else {
                        var past = Math.abs(days);
                        el.textContent = past + ' days ago';
                        el.title = past + ' day' + (past===1?'':'s') + ' ago';
                    }
                });
            }
            hydrateCountdown();
    })();
</script>
<script src="/static/js/pages/event_tasks.js"></script>
{% endblock %}
