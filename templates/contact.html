{% extends "base.html" %}

{% block title %}Contact Support - EPU{% endblock %}

{% block content %}
<div class="container section center">
  {% from 'components/macros.html' import page_hero, notice %}
  {{ page_hero('Contact Support', 'We usually respond within 1 business day.') }}
  {% if error %}
    {{ notice(error, 'error') }}
  {% endif %}
  <style>
    .contact-narrow { max-width: 580px; margin: 0 auto; }
    .contact-banner { text-align:left; margin: 0 auto 16px; }
    .contact-gap { height: 8px; }
    .contact-banner .cb-title { margin-bottom: 8px; }
    .contact-banner .cb-grid { display: grid; gap: 6px; }
  .contact-banner .cb-row { display: grid; grid-template-columns: 110px 1fr; gap: 8px; align-items: baseline; }
    .contact-banner .cb-label { color: #ffe6a8; font-weight: 600; }
    .contact-banner .cb-value code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; word-break: break-all; display:inline-block; max-width:100%; }
    .contact-banner .cb-copy { border: 1px solid rgba(255,255,255,0.25); background: rgba(0,0,0,0.15); color:#fff; padding:4px 8px; border-radius:6px; cursor:pointer; font-size:.85rem; }
    .contact-banner .cb-copy:hover { background: rgba(0,0,0,0.25); }
    /* Inline clear control style */
    .contact-clear-btn { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:999px; border:1px solid transparent; background: var(--color-danger, #c62828); color: #fff; font-size:.85em; line-height:1; cursor:pointer; transition: filter .15s ease, transform .02s ease; vertical-align: middle; }
    .contact-clear-btn:hover { filter: brightness(1.05); }
    .contact-clear-btn:active { transform: translateY(1px); }
    .contact-clear-btn:focus { outline: 2px solid #ffd2d2; outline-offset: 2px; }
  </style>
  <div class="contact-narrow">
  {% if request_id %}
    {% call notice('', 'warn', 'class="contact-banner"') %}
      <div class="cb-title">We detected a recent error on your request. We’ll include details in your message automatically in a moment.</div>
      <div class="cb-grid">
        <div class="cb-row">
          <div class="cb-label">Request ID</div>
          <div class="cb-value"><code id="cb-rqid">{{ request_id }}</code></div>
        </div>
        {% if request_url %}
        <div class="cb-row">
          <div class="cb-label">Page</div>
          <div class="cb-value"><a id="cb-url" href="{{ request_url }}" target="_blank" rel="noopener noreferrer"><code>{{ request_url }}</code></a></div>
        </div>
        {% endif %}
      </div>
    {% endcall %}
  {% endif %}
  <div id="contact-meta" hidden data-request-id="{{ request_id or '' }}" data-request-url="{{ request_url or '' }}"></div>
  <div class="contact-gap" aria-hidden="true"></div>
  <form class="card form center contact-narrow" method="post">
      <div class="floating-field">
        <label for="contact_name" class="fl-label">Name</label>
        <input class="input-field" type="text" id="contact_name" name="name" required autocomplete="name" maxlength="80" value="{{ (form.name if form else '') | e }}">
        <div class="muted" style="text-align:right; margin-top:4px;"><small id="name-counter">0/80</small></div>
      </div>
      <div class="floating-field">
        <label for="contact_email" class="fl-label">Email</label>
        <input class="input-field" type="email" id="contact_email" name="email" required autocomplete="email" maxlength="254" value="{{ (form.email if form else '') | e }}">
        <div class="muted" style="text-align:right; margin-top:4px;"><small id="email-counter">0/254</small></div>
      </div>
      <div class="floating-field">
        <label for="contact_topic" class="fl-label">Topic</label>
        <select class="input-field" id="contact_topic" name="topic" required>
          <option value="" disabled {% if not form or not form.topic %}selected{% endif %}>Select a topic</option>
          <option {% if form and form.topic=='Abuse/report' %}selected{% endif %}>Abuse/report</option>
          <option {% if form and form.topic=='Account' %}selected{% endif %}>Account</option>
          <option {% if form and form.topic=='Billing' %}selected{% endif %}>Billing</option>
          <option {% if form and form.topic=='Data/privacy' %}selected{% endif %}>Data/privacy</option>
          <option {% if form and form.topic=='Event help' %}selected{% endif %}>Event help</option>
          <option {% if form and form.topic=='Feature request' %}selected{% endif %}>Feature request</option>
          <option {% if form and form.topic=='Technical issue' %}selected{% endif %}>Technical issue</option>
          <option {% if form and form.topic=='Other' %}selected{% endif %}>Other</option>
        </select>
      </div>
      <div id="billing-extra" style="display:none;">
        <div class="floating-field">
          <label for="order_number" class="fl-label">Order number (optional)</label>
          <input class="input-field" type="text" id="order_number" name="order_number" placeholder="ch_... or inv_..." value="{{ (form.order_number if form else '') | e }}">
        </div>
        <div class="floating-field">
          <label for="event_url" class="fl-label">Event URL (optional)</label>
          <input class="input-field" type="url" id="event_url" name="event_url" placeholder="https://.../events/123" value="{{ (form.event_url if form else '') | e }}">
        </div>
      </div>
      <div id="subject-other" style="display:none;">
        <div class="floating-field">
          <label for="contact_subject" class="fl-label">Subject</label>
          <input class="input-field" type="text" id="contact_subject" name="subject" maxlength="120" value="{{ (form.subject if form else '') | e }}">
          <div class="muted" style="text-align:right; margin-top:4px;"><small id="subject-counter">0/120</small></div>
        </div>
      </div>
      <div class="floating-field">
        <label for="contact_message" class="fl-label">How can we help?
          <button id="clear-inserted" type="button" class="contact-clear-btn" hidden aria-label="Remove error details" style="margin-left:8px;">Remove error details</button>
        </label>
        <textarea class="input-field" id="contact_message" name="message" rows="8" style="resize: vertical;" maxlength="2000" required placeholder="Tell us how we can help…">{{ (form.message if form else '') | e }}</textarea>
        <div class="muted" style="text-align:right; margin-top:4px;"><small id="message-counter">0/2000</small></div>
      </div>
  <!-- Honeypot field for bots (leave empty) -->
  <div style="position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;">
    <label>Company<input type="text" name="hp" tabindex="-1" autocomplete="off"></label>
  </div>
  <!-- Optional CAPTCHA widget placeholder (e.g., Turnstile/hCaptcha). When enabled, set a hidden token field named captcha_token. -->
  <input type="hidden" name="captcha_token" value="">
  <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
  <button class="btn primary block" type="submit">Send</button>
  </form>
  </div>
</div>
{% block extra_js %}
<script>
  (function(){
    var sel = document.getElementById('contact_topic');
    var extra = document.getElementById('billing-extra');
    var subjWrap = document.getElementById('subject-other');
    var msg = document.getElementById('contact_message');
    var examples = {
      'Account': 'Log in issues, email changes, profile…',
      'Abuse/report': 'Link to the event/file and what’s wrong…',
      'Billing': 'Refund, invoice, VAT, or charge questions…',
      'Data/privacy': 'Data export/deletion, privacy questions…',
      'Event help': 'Share your event code and what you need…',
      'Feature request': 'What feature would help you most?…',
      'Technical issue': 'Describe the issue and steps to reproduce…',
      'Other': 'Tell us how we can help…'
    };
    function sync(){
      if (!sel) return;
      var v = sel.value || '';
      if (extra) extra.style.display = (v === 'Billing') ? 'block' : 'none';
      if (subjWrap) subjWrap.style.display = (v === 'Other') ? 'block' : 'none';
      if (msg) msg.placeholder = examples[v] || examples['Other'];
    }
    if (sel){ sel.addEventListener('change', sync); }
    // Counters
    function bindCounter(input, counterEl, max){
      if (!input || !counterEl) return;
      function update(){ var len = (input.value||'').length; counterEl.textContent = len + '/' + max; }
      input.addEventListener('input', update); update();
    }
    bindCounter(document.getElementById('contact_name'), document.getElementById('name-counter'), 80);
    bindCounter(document.getElementById('contact_email'), document.getElementById('email-counter'), 254);
    bindCounter(document.getElementById('contact_subject'), document.getElementById('subject-counter'), 120);
    bindCounter(document.getElementById('contact_message'), document.getElementById('message-counter'), 2000);
    // Initial sync after potential server-side prefill
    sync();

    // Delayed auto-insert of Request ID and page into the message
    try {
      var meta = document.getElementById('contact-meta');
      var rqid = meta ? (meta.dataset.requestId || null) : null;
      var rqurl = meta ? (meta.dataset.requestUrl || null) : null;
      if (msg && rqid) {
        setTimeout(function(){
          var text = msg.value || '';
          var hasId = /Request ID\s*:/i.test(text);
          var hasPage = /Page\s*:/i.test(text);
          var parts = [];
          if (!hasId) parts.push('Request ID: ' + rqid);
          if (rqurl && !hasPage) parts.push('Page: ' + rqurl);
          if (parts.length) {
            msg.value = parts.join('\n') + (text ? ('\n\n' + text) : '');
            // Move cursor to end for convenience
            try { msg.selectionStart = msg.selectionEnd = msg.value.length; } catch(e){}
            // Update counter
            var msgCounter = document.getElementById('message-counter');
            if (msgCounter) msgCounter.textContent = (msg.value.length) + '/2000';
          }
          // Toggle clear button visibility based on presence of error details
          if (clearBtn) { clearBtn.hidden = !detectInserted(msg.value); }
        }, 800); // slight delay so user can start typing if they want
      }
    } catch (e) { /* no-op */ }

    // Clear inserted details control
    var clearBtn = document.getElementById('clear-inserted');
    function detectInserted(text){
      var str = text || '';
      var lines = str.split(/\r?\n/);
      var i = 0;
      var hasId = !!(lines[i] && /^\s*Request ID\s*:/i.test(lines[i]));
      if (hasId) i++;
      var hasPage = !!(lines[i] && /^\s*Page\s*:/i.test(lines[i]));
      return hasId || hasPage;
    }
    function clearInserted(){
      if (!msg) return;
      var text = msg.value || '';
      // Remove leading Request ID/Page lines if present, preserving user content
      var lines = text.split(/\r?\n/);
      // Remove up to first two lines if they match patterns
      var start = 0;
      if (lines[start] && /^\s*Request ID\s*:/i.test(lines[start])) start++;
      if (lines[start] && /^\s*Page\s*:/i.test(lines[start])) start++;
      // Also remove a single empty line after those, if present
      if (lines[start] === '') start++;
      var rest = lines.slice(start).join('\n');
      msg.value = rest;
      try { msg.selectionStart = msg.selectionEnd = msg.value.length; } catch(e){}
      var msgCounter = document.getElementById('message-counter');
      if (msgCounter) msgCounter.textContent = (msg.value.length) + '/2000';
      // Hide then remove the button after clearing
      if (clearBtn) { clearBtn.hidden = true; setTimeout(function(){ if (clearBtn && clearBtn.parentNode) { try { clearBtn.remove(); } catch(e) { clearBtn.style.display = 'none'; } } }, 0); }
    }
    if (clearBtn){ clearBtn.addEventListener('click', clearInserted); }

    // Keep button visibility in sync if user edits the message
    if (msg && clearBtn){
      clearBtn.hidden = !detectInserted(msg.value);
      msg.addEventListener('input', function(){ clearBtn.hidden = !detectInserted(msg.value); });
    }

    // copy buttons removed by request
  })();
</script>
{% endblock %}
{% endblock %}
