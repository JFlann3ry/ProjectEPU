{% extends "base.html" %}

{% block title %}Event Details - EPU{% endblock %}
{% block extra_head %}
    {% if canonical_url %}<link rel="canonical" href="{{ canonical_url }}">{% endif %}
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs-container section" style="padding-bottom:0;">
    {% if event %}
    <nav class="breadcrumbs small muted" aria-label="Breadcrumb">
        <a href="/events" class="crumb">My Events</a>
        <span class="sep" aria-hidden="true">‚Ä∫</span>
    <span class="crumb current" aria-current="page">{{ event.Name or 'Event' }}</span>
    </nav>
    {% else %}
    <nav class="breadcrumbs small muted" aria-label="Breadcrumb">
        <a href="/events" class="crumb">My Events</a>
        <span class="sep" aria-hidden="true">‚Ä∫</span>
    <span class="crumb current" aria-current="page">Event Details</span>
    </nav>
    {% endif %}
</div>
{% endblock %}
{% block content %}
<div class="container section center event-details">
    <div class="page-hero" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div>
                        <h1 class="hero-title">Event Details</h1>
                        <p class="hero-sub">Manage your event, guest access, and sharing options.</p>
                </div>
        </div>
        {% if event %}
            {% if event.IsDateLocked or event.Published %}
                <div class="notice error" style="margin: 8px 0 16px 0;">
                        This event date is finalised and cannot be changed. {% if event.DateLockedAt %}Locked at: <span class="p-bold">{{ event.DateLockedAt|dtfmt }}</span>{% endif %}
                </div>
            {% endif %}
            {% set etname = (event.EventTypeName or '') %}
            {% set etkey = etname|lower %}
        {% set etmap = {
            'wedding':'üíç', 'birthday':'üéÇ', 'party':'üéâ', 'corporate':'üè¢', 'conference':'üé§', 'sports':'üèüÔ∏è',
            'holiday':'üéÑ', 'baby shower':'üçº', 'graduation':'üéì', 'concert':'üéµ', 'festival':'üé™', 'engagement':'üíû', 'funeral':'üïäÔ∏è'
        } %}
            {% set etemoji = etmap.get(etkey, 'üì∑') %}
            {% set etimgmap = {
                    'wedding':'/static/images/examples/wedding1.svg',
                    'corporate':'/static/images/examples/corporate1.svg',
                    'school':'/static/images/examples/school1.svg'
            } %}
            {% set etimg = etimgmap.get(etkey, '/static/images/examples/corporate1.svg') %}

            <div class="grid equal-heights" style="grid-template-columns: minmax(360px, 1.6fr) minmax(260px, 1fr); gap:14px;">
                <section class="card full-height event-card v5" style="min-height: 220px;">
                    <div class="cover" style="position:relative; overflow:hidden; padding-right:6px;">
                        <div class="title-row" style="position:relative; display:flex; justify-content:space-between; align-items:stretch; gap:12px;">
                            <div class="title-left" style="display:flex; flex-direction:column; align-items:flex-start; gap:4px; flex:1 1 auto; min-width:0;">
                                <h3 class="event-title" title="{{ event.Name }}">{{ event.Name }}</h3>
                                <div class="status-pills published">
                                    {% if event.Published %}
                                        <span class="pill success" title="Publicly accessible">Published</span>
                                    {% else %}
                                        <span class="pill warn" title="Not published">Unpublished</span>
                                    {% endif %}
                                    {% if event.IsDateLocked %}<span class="pill warn" title="Date is locked">Locked</span>{% endif %}
                                </div>
                            </div>
                            <div class="title-right" style="position:relative; display:flex; align-items:center; gap:8px; margin-left:auto; padding-right:0; width:auto;">
                                <button class="btn ghost share-btn" type="button" data-event-id="{{ event.EventID }}" data-code="{{ event.Code }}" data-published="{{ 1 if event.Published else 0 }}" data-title="{{ event.Name }}" title="Share options" style="position:absolute; top:6px; right:6px; bottom:6px; display:flex; align-items:center;">
                                    <svg class="icn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M15 8a3 3 0 1 0-2.83-4H12A3 3 0 0 0 9 7a3 3 0 0 0 .17 1.02l-1.9 1.13A3 3 0 1 0 9 14.98l1.9-1.13A3 3 0 0 0 12 15a3 3 0 1 0 2.83-4.02l-1.9-1.13A3.01 3.01 0 0 0 12 9c0-.35.06-.68.17-1.02l1.9-1.13A3 3 0 0 0 15 8Z" stroke="currentColor" stroke-width="1.5"/></svg>
                                    <span>Share</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="body">
                        <div class="row top" style="grid-template-columns: 100px 1fr;">
                            <div class="date-col" style="display:flex; flex-direction:column; gap:8px; align-items:center;">
                                <div class="date-card" title="Event date">
                                <div class="date-top">
                                    <svg class="icn calendar-mini" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M3 9h18" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M8 3v4M16 3v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                    {% if event.Date %}
                                        {% set mon = event.Date.strftime('%b') %}
                                        <span class="mon">{{ mon }}</span>
                                    {% else %}
                                        <span class="mon">‚Äî</span>
                                    {% endif %}
                                </div>
                                {% if event.Date %}
                                    {% set dayn = event.Date.day %}
                                    <div class="date-day">{{ '%02d' % dayn }}<sup style="font-size:0.55em; vertical-align:super; margin-left:1px;">{{ dayn|ordsuffix }}</sup></div>
                                    <div class="date-foot" data-date="{{ event.Date.isoformat() }}">Calculating‚Ä¶</div>
                                {% else %}
                                    <div class="date-day">‚Äî</div>
                                    <div class="date-foot">No date</div>
                                {% endif %}
                                </div>
                                {% if event_type %}
                                <div class="event-type-chip">
                                    <span class="pill" title="Event type">{{ etemoji }} {{ event_type.Name }}</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="thumb" aria-label="Event photo" style="width:100%; height:100%; min-height:120px; border-radius:12px; border:1px solid var(--color-border); background:#0f1322; overflow:hidden; display:flex; align-items:center; justify-content:center; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);">
                                {% if custom and custom.CoverPhotoPath %}
                                    <img src="{{ custom.CoverPhotoPath }}" alt="Event cover" style="width:100%; height:100%; object-fit:cover; display:block;" loading="lazy">
                                {% else %}
                                    <img src="{{ etimg }}" alt="Event illustration" style="width:100%; height:100%; object-fit:cover; display:block; opacity:0.9;" loading="lazy">
                                {% endif %}
                            </div>
                        </div>

                        <div class="kv" style="margin: 12px 0 8px;">
                            <div class="kv-row">
                                <div class="kv-label">Welcome Message</div>
                                <div class="kv-value muted">{{ custom.WelcomeMessage if custom and custom.WelcomeMessage else '‚Äî' }}</div>
                            </div>
                            <div class="kv-row" style="border-top:1px solid rgba(255,255,255,0.08); margin-top:6px; padding-top:6px;">
                                <div class="kv-label">Upload Message</div>
                                <div class="kv-value muted">{{ custom.UploadInstructions if custom and custom.UploadInstructions else '‚Äî' }}</div>
                            </div>
                        </div>

                        <div class="spacer"></div>
                        <div class="actions btn-row" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px;">
                            <a class="btn accent" href="/events/{{ event.EventID }}/edit" title="Edit event" style="width:100%; justify-content:center;">
                                <svg class="icn" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 15.5V20h4.5L19 9.5 14.5 5 4 15.5Z" stroke="currentColor" stroke-width="1.5"/></svg>
                                <span>Edit</span>
                            </a>
                            <button type="button" class="btn gallery-btn" data-gallery-select data-event-id="{{ event.EventID }}" title="Open gallery" style="width:100%; justify-content:center;">
                                <svg class="icn" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M7 14l3-3 3 3 3-3 3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="9" r="1.5" fill="currentColor"/></svg>
                                <span>Gallery</span>
                            </button>
                            {% if event.Date and not (event.IsDateLocked or event.Published) %}
                            <button id="open-lock" type="button" class="btn danger" title="Lock event date" style="grid-column: 1 / -1; width:100%; justify-content:center;">
                                <svg class="icn" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="10" width="16" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 10V7a4 4 0 0 1 8 0v3" stroke="currentColor" stroke-width="1.5"/></svg>
                                <span>Lock Event Date</span>
                            </button>
                            {% endif %}
                            <a class="btn" href="/addons?event_id={{ event.EventID }}" title="Purchase extras" style="grid-column: 1 / -1; width:100%; justify-content:center;">
                                <svg class="icn" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6h15l-1.5 9a3 3 0 0 1-3 2.5H9.5a3 3 0 0 1-3-2.5L5 4H3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="20" r="1" fill="currentColor"/><circle cx="17" cy="20" r="1" fill="currentColor"/></svg>
                                <span>Purchase Extras</span>
                            </a>
                        </div>
                        
                    </div>
                </section>

    <div class="col-right" style="display:flex; flex-direction:column; gap:14px; min-height:100%;">
        <aside class="card" style="display:flex; flex-direction:column;">
            <h3>Guest Upload</h3>
            <div class="qr-wrap">
                <a href="{{ guest_url }}" target="_blank" style="display:inline-block;">
                    <img class="qr" src="/qr?url={{ guest_url | urlencode }}&theme=classic" alt="QR Code to guest upload" style="width:140px;height:140px;border-radius:8px;display:block;">
                </a>
            </div>
            <form class="form" style="margin-top:6px; background: transparent; border: none; padding: 0;">
                <div class="grid" style="grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px;">
                    <div class="floating-field">
                        <label class="fl-label" for="event-code">Code</label>
                        <div class="input-with-btn" style="margin-top:6px;">
                            <input id="event-code" class="input-field" type="text" value="{{ event.Code }}" readonly autocomplete="off" title="Click to copy code" style="cursor:pointer;">
                        </div>
                    </div>
                    <div class="floating-field">
                        <label class="fl-label" for="event-pass">Password</label>
                        {% if event.Password %}
                        <div class="input-with-btn" style="margin-top:6px;">
                            <input id="event-pass" class="input-field" type="text" value="{{ event.Password }}" readonly autocomplete="off" title="Click to copy password" style="cursor:pointer;">
                        </div>
                        {% else %}
                        <input class="input-field" type="text" value="None" readonly>
                        {% endif %}
                    </div>
                </div>
                <div class="floating-field" style="margin-top:8px;">
                    <label class="fl-label" for="guest-link">Login link</label>
                    <div class="input-with-btn" style="margin-top:6px;">
                        <input id="guest-link" class="input-field" type="text" value="{{ request.base_url }}guest/upload/{{ event.Code }}" readonly autocomplete="off" title="Click to copy link" style="cursor:pointer;">
                    </div>
                </div>
            </form>
        </aside>

        <aside class="card full-height" style="display:flex; flex-direction:column; flex:1 1 auto;">
            <h3>Event Stats</h3>
            <div class="kv" style="margin-top:6px; display:flex; flex-direction:column; gap:6px; flex:1 1 auto;">
                <div class="kv-row" style="display:grid; grid-template-columns: 1fr auto; align-items:center; padding:4px 0;">
                    <div class="kv-label muted">Total uploads</div>
                    <div class="kv-value" style="text-align:right; font-variant-numeric: tabular-nums; font-feature-settings: 'tnum' 1, 'lnum' 1; font-weight:600;">{{ upload_stats.total }}</div>
                </div>
                <div class="kv-row" style="display:grid; grid-template-columns: 1fr auto; align-items:center; padding:4px 0; border-top:1px solid rgba(255,255,255,0.08);">
                    <div class="kv-label muted">Photos</div>
                    <div class="kv-value" style="text-align:right; font-variant-numeric: tabular-nums; font-feature-settings: 'tnum' 1, 'lnum' 1; font-weight:600;">{{ upload_stats.images }}</div>
                </div>
                <div class="kv-row" style="display:grid; grid-template-columns: 1fr auto; align-items:center; padding:4px 0; border-top:1px solid rgba(255,255,255,0.08);">
                    <div class="kv-label muted">Videos</div>
                    <div class="kv-value" style="text-align:right; font-variant-numeric: tabular-nums; font-feature-settings: 'tnum' 1, 'lnum' 1; font-weight:600;">{{ upload_stats.videos }}</div>
                </div>
                <div class="kv-row" style="display:grid; grid-template-columns: 1fr auto; align-items:center; padding:4px 0; border-top:1px solid rgba(255,255,255,0.08);">
                    <div class="kv-label muted">Guests Uploaded</div>
                    <div class="kv-value" style="text-align:right; font-variant-numeric: tabular-nums; font-feature-settings: 'tnum' 1, 'lnum' 1; font-weight:600;">{{ upload_stats.unique_uploaders }}</div>
                </div>
            </div>
        </aside>

        {% if extras and extras|length > 0 %}
        <aside class="card">
            <h3 style="margin:0 0 8px;">Extras</h3>
            <div class="muted small" style="margin-bottom:8px;">Enhance this event with add-ons</div>
            <div class="grid" style="grid-template-columns: 1fr; gap:10px;">
                {% for a in extras %}
                    {% set c = (a.currency or 'gbp')|lower %}
                    {% set sym = '¬£' if c == 'gbp' else ('$' if c == 'usd' else c|upper ~ ' ') %}
                    {% set price = (a.price_cents or 0) / 100 %}
                    <div class="card" style="padding:10px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                            <div>

                                

                                <div class="p-bold">{{ a.name }}</div>
                                {% if a.desc %}<div class="muted small">{{ a.desc }}</div>{% endif %}
                            </div>
                            <div style="text-align:right;">
                                <div class="p-bold">{{ sym }}{{ '%.2f'|format(price) }}</div>
                                {% if a.allow_qty %}
                                    <label class="muted small" for="ex-qty-{{ a.code }}">Qty</label>
                                    <input id="ex-qty-{{ a.code }}" type="number" min="{{ a.min_qty }}" max="{{ a.max_qty }}" value="{{ a.min_qty }}" style="width:78px;">
                                {% endif %}
                            </div>
                        </div>
                        <div style="margin-top:8px; display:flex; justify-content:flex-end;">
                            {% if request.cookies.get('session_id') %}
                            <button class="btn sm" data-code="{{ a.code }}" data-allowqty="{{ '1' if a.allow_qty else '0' }}" onclick="buyEventAddon(this, {{ event.EventID }})">Buy</button>
                            {% else %}
                            <a class="btn sm" href="/signup">Sign up to buy</a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div style="margin-top:10px;">
                <a class="small" href="/addons">Browse all add-ons ‚Üí</a>
            </div>
        </aside>
        {% endif %}
    </div>
            </div>
            <div class="card" style="margin-top:14px;">
                <h3 style="margin:0 0 8px;">Guestbook</h3>
                {% set has_messages = messages and messages|length > 0 %}
                {% if not has_messages %}
                    <div class="muted">No messages yet.</div>
                {% else %}
                    <ul class="list" style="list-style:none; padding:0; margin:0; display:grid; gap:10px;">
                        {% for m in messages %}
                            <li class="gb-row" style="position:relative; border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:12px; background: rgba(255,255,255,0.02);">
                                <div class="gb-msg" style="white-space: pre-wrap;">{{ m.Message }}</div>
                                <div class="gb-sig" style="position:absolute; right:12px; bottom:-10px; background:#0b0b10; padding:2px 8px; border:1px solid rgba(255,255,255,0.12); border-radius:8px; font-style:italic; font-weight:600; font-size:0.95em;">&mdash; {{ m.DisplayName or 'Guest' }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
    {% else %}
      <div class="notice error">Event not found.</div>
    {% endif %}
 </div>
<!-- Hidden form used by shared modal to submit lock action -->
<form id="lock-date-form" method="post" action="/events/{{ event.EventID }}/lock-date" style="display:none;"></form>
<script>
    document.addEventListener('DOMContentLoaded', function(){
        // Handle Gallery open without form wrappers
        document.addEventListener('click', async function(e){
            var gb = e.target.closest('[data-gallery-select]');
            if (gb){
                e.preventDefault();
                var eid = gb.getAttribute('data-event-id');
                if (!eid) return;
                try {
                    var res = await fetch('/gallery/select', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' },
                        body: 'event_id=' + encodeURIComponent(eid)
                    });
                    if (res.ok) { window.location.href = '/gallery'; }
                    else { if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show('Failed to open gallery'); }
                } catch(err){ if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show('Network error'); }
            }
        });

                // Share modal like My Events
                function esc(s){ return (s||'').replace(/[&<>"]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]) || c; }); }
                function openShare(code, published, title){
                        var url = new URL('/e/' + code, window.location.origin).href;
                        var encUrl = encodeURIComponent(url);
                        var encTitle = encodeURIComponent(title || 'My event');
                        var warn = !published ? '<div class="notice" style="margin-bottom:10px;">This event is not published. Shared links may not be viewable by others until you publish.</div>' : '';
                        var body = warn +
                                '<div class="btn-row" style="flex-wrap:wrap; gap:10px;">' +
                                '<a class="btn" href="https://wa.me/?text=' + encTitle + '%20' + encUrl + '" target="_blank" rel="noopener" title="Share via WhatsApp">' +
                                '<span>WhatsApp</span>' +
                                '</a>' +
                                '<a class="btn" href="fb-messenger://share/?link=' + encUrl + '" target="_blank" rel="noopener" title="Share via Messenger (mobile)">' +
                                '<span>Messenger</span>' +
                                '</a>' +
                                '<a class="btn" href="mailto:?subject=' + encTitle + '&body=' + encTitle + '%0A' + encUrl + '" title="Share via Email">' +
                                '<span>Email</span>' +
                                '</a>' +
                                '<button class="btn share-copy" type="button" data-url="' + esc(url) + '"><span>Copy Link</span></button>' +
                                '</div>' +
                                '<div class="small muted" style="margin-top:6px;">The share page URL is ' + esc(url) + '</div>';
                        if (window.EPU && window.EPU.modal){ window.EPU.modal.show({ title: 'Share Event', body: body, fit: true, actions: [], noDefaultClose: true }); }
                }
                async function copyToClipboard(text){
                        try { if (navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(text); return true; } } catch(e){}
                        try { var ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; } catch(e){ return false; }
                }
    document.addEventListener('click', function(e){
                        var shareBtn = e.target.closest('.share-btn');
                        if (shareBtn){
                                e.preventDefault();
                                var code = shareBtn.getAttribute('data-code');
                                var pub = shareBtn.getAttribute('data-published') === '1';
                                var title = shareBtn.getAttribute('data-title') || 'My event';
                                openShare(code, pub, title);
                                return;
                        }
            var copyBtn = e.target.closest('.share-copy');
            if (copyBtn){
                var u = copyBtn.getAttribute('data-url');
                copyToClipboard(u).then(function(ok){ if (window.EPU && window.EPU.snackbar){ window.EPU.snackbar.show(ok?'Link copied':'Copy failed', { hideAction: true }); } });
                return;
            }
                });
        // Copy helpers using global snackbar
    async function copyFrom(inputEl, message){
            try {
                if (!inputEl) return;
                if (navigator.clipboard && navigator.clipboard.writeText){
                    await navigator.clipboard.writeText(inputEl.value);
                } else {
                    var prev = inputEl.getAttribute('readonly');
                    inputEl.removeAttribute('readonly');
                    inputEl.select();
                    document.execCommand('copy');
                    if (prev !== null) inputEl.setAttribute('readonly', '');
                }
    if (window.EPU && window.EPU.snackbar){ window.EPU.snackbar.show(message || 'Copied', { hideAction: true }); }
            } catch (e) {
    if (window.EPU && window.EPU.snackbar){ window.EPU.snackbar.show('Copy failed', { hideAction: true }); }
            }
        }
    var linkInput = document.getElementById('guest-link');
    if (linkInput){ linkInput.addEventListener('click', function(){ copyFrom(linkInput, 'Link copied to clipboard'); }); }
    var copyGuestBtn = document.getElementById('copy-guest-link-btn');
    if (copyGuestBtn && linkInput){ copyGuestBtn.addEventListener('click', function(){ copyFrom(linkInput, 'Link copied to clipboard'); }); }
    var codeInput = document.getElementById('event-code');
    if (codeInput){ codeInput.addEventListener('click', function(){ copyFrom(codeInput, 'Code copied to clipboard'); }); }
    var passInput = document.getElementById('event-pass');
    if (passInput){ passInput.addEventListener('click', function(){ copyFrom(passInput, 'Password copied to clipboard'); }); }
        var copyShareBtn = document.getElementById('copy-share');
        if (copyShareBtn){ copyShareBtn.addEventListener('click', function(){
            var tmp = document.createElement('input');
            tmp.style.position='fixed'; tmp.style.left='-9999px';
            tmp.value = window.location.origin + '/e/{{ event.Code }}';
            document.body.appendChild(tmp);
            copyFrom(tmp, 'Share link');
            document.body.removeChild(tmp);
        }); }

        // Lock date confirmation via shared modal
        var openLock = document.getElementById('open-lock');
        var lockForm = document.getElementById('lock-date-form');
        if (openLock && lockForm && window.EPU && window.EPU.modal){
            openLock.addEventListener('click', function(){
                window.EPU.modal.show({
                    title: 'Lock Event Date?',
                    body: '<p class="muted">This will finalise your event. The date cannot be changed after locking. Are you sure you want to continue?</p>',
                    actions: [
                        { label: 'Cancel', role: 'cancel', onClick: function(hide){ hide(); } },
                        { label: 'Yes, lock date', danger: true, onClick: function(){ lockForm.submit(); } }
                    ]
                });
            });
        }

        // Countdown footer inside date card
        (function hydrateCountdown(){
            var now = new Date();
            document.querySelectorAll('.event-card.v5 .date-foot[data-date]').forEach(function(el){
                var iso = el.getAttribute('data-date');
                if(!iso) return;
                var dt = new Date(iso);
                if(isNaN(dt)) return;
                var diffMs = dt.setHours(0,0,0,0) - (new Date(now)).setHours(0,0,0,0);
                var days = Math.round(diffMs / 86400000);
                if (days > 0){
                    el.textContent = days + ' days';
                    el.title = days + ' day' + (days===1?'':'s') + ' to go';
                } else if (days === 0){
                    el.textContent = 'Today';
                    el.title = 'Event is today';
                } else {
                    var past = Math.abs(days);
                    el.textContent = past + ' days ago';
                    el.title = past + ' day' + (past===1?'':'s') + ' ago';
                }
            });
        })();
    });
</script>
{% if extras and extras|length > 0 %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
    async function buyEventAddon(btn, eventId){
        const code = btn.dataset.code;
        const allowQty = btn.dataset.allowqty === '1';
        const qtyEl = allowQty ? document.getElementById(`ex-qty-${code}`) : null;
        const quantity = qtyEl ? Math.max(parseInt(qtyEl.value||'1',10)||1, 1) : 1;
        try {
            const res = await fetch('/addons/checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code, quantity, event_id: eventId }) });
            if (res.status === 401 || res.status === 403) { window.location = '/login'; return; }
            const data = await res.json();
            if (!data.id) throw new Error('Invalid response');
            stripe.redirectToCheckout({ sessionId: data.id });
        } catch (e) {
            if (window.EPU && window.EPU.snackbar) window.EPU.snackbar.show('Unable to start checkout');
        }
    }
</script>
{% endif %}
{% endblock %}
