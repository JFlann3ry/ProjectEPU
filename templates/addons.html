{% extends "base.html" %}

{% block title %}Extras (formerly Add-ons){% endblock %}

{% block content %}
<div class="container">
  {% from 'components/macros.html' import page_hero, notice %}
  {{ page_hero('Extras', 'Enhance your event with live gallery links, extra events, QR cards, and more.') }}
  {{ notice('Heads up: this page moved to <a href="/extras">/extras</a>. You can update any bookmarks.', attrs='class="small" role="status" style="margin-top:10px;"') }}

  {% set qs = request.query_params %}
  {% if qs.get('success') == '1' %}
    {{ notice('Checkout complete. Your extra will appear shortly.', kind='success', attrs='role="status" style="margin: 12px 0;"') }}
  {% elif qs.get('canceled') == '1' %}
    {{ notice('Checkout canceled.', attrs='role="status" style="margin: 12px 0;"') }}
  {% endif %}

  <section class="section">
    <div class="grid grid-2">
      {% for a in addons %}
      {% set c = (a.currency or 'gbp')|lower %}
      {% set sym = '£' if c == 'gbp' else ('$' if c == 'usd' else c|upper ~ ' ') %}
      {% set price = (a.price_cents or 0) / 100 %}
      <div class="card">
        <h3 style="margin-top:0;">{{ a.name }}</h3>
        {% if a.desc %}<p class="muted">{{ a.desc }}</p>{% endif %}
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="font-weight:800; font-size:22px;">{{ sym }}{{ '%.2f'|format(price) }}</div>
          {% if a.allow_qty %}
          <label class="muted" for="qty-{{ a.code }}" style="margin-left:6px;">Qty</label>
          <input id="qty-{{ a.code }}" type="number" min="{{ a.min_qty }}" max="{{ a.max_qty }}" value="{{ a.min_qty }}" style="width:90px;" />
          {% endif %}
        </div>
        <div style="margin-top:12px;">
          {% if request.cookies.get('session_id') %}
          <button class="btn primary" data-code="{{ a.code }}" data-allowqty="{{ '1' if a.allow_qty else '0' }}" onclick="buyAddon(this)">Buy</button>
          {% else %}
          <a class="btn primary" href="/signup">Sign up to purchase</a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
        {% if not addons or addons|length == 0 %}
        <article class="card" style="display:flex; flex-direction:column; align-items:stretch;">
          <div style="display:flex; align-items:center; justify-content:center; padding:10px 10px 0;">
            <img src="/static/images/examples/corporate1.svg" alt="Live Gallery Link (Sample)" style="width:100%; max-width: 160px; height: auto; object-fit: contain; display:block;" loading="lazy">
          </div>
          <div style="padding: 10px 12px;">
            <h3 style="margin:0 0 6px; text-align:center;">Live Gallery Link</h3>
            <p class="muted" style="margin: 0 0 10px; text-align:center;">Display uploads in real-time on a shareable gallery page.</p>
          </div>
          <div style="margin-top:auto; padding: 10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div class="p-bold" style="font-size:18px;">£10.00</div>
              {% if request.cookies.get('session_id') %}
              <a class="btn" href="/gallery" role="button">Open Live Gallery</a>
              {% else %}
              <button class="btn" disabled title="Sample card">Add to event</button>
              {% endif %}
          </div>
        </article>
        {% endif %}
    </div>
  {% from 'components/macros.html' import btn_row %}
  {% call btn_row('style="margin-top:16px;"') %}
  {% set ev_code = request.query_params.get('event_code') %}
  {% if ev_code %}
  <a class="btn" href="/events/code/{{ ev_code }}">Back to Event</a>
      {% else %}
      <a class="btn" href="/events">Back to My Events</a>
      {% endif %}
  {% endcall %}
  </section>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
function getQueryParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
async function buyAddon(btn){
  const code = btn.dataset.code;
  const allowQty = btn.dataset.allowqty === '1';
  const qtyEl = allowQty ? document.getElementById(`qty-${code}`) : null;
  const quantity = qtyEl ? Math.max(parseInt(qtyEl.value||'1',10)||1, 1) : 1;
  const event_code = getQueryParam('event_code');
  try {
  const res = await fetch('/extras/checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code, quantity, event_code }) });
    if (res.status === 401 || res.status === 403) { window.location = '/login'; return; }
    const data = await res.json();
    if (!data.id) throw new Error('Invalid response');
    stripe.redirectToCheckout({ sessionId: data.id });
  } catch (e) {
    alert('Unable to start checkout. Please try again.');
  }
}
</script>
{% endblock %}
