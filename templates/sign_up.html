{% extends "base.html" %}
{% from "components/macros.html" import page_hero, notice %}

{% block title %}Sign Up - EPU{% endblock %}

{% block content %}
<div class="container section center">
    {{ page_hero('Create your account', 'Start hosting events and collecting memories.', True) }}
    <form class="card form center" method="post" action="/auth/signup" style="max-width:520px;">
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="floating-field">
                  <label for="first_name" class="fl-label">First Name</label>
                  <input class="input-field" type="text" id="first_name" name="first_name" required value="{{ first_name or '' }}" autocomplete="given-name" autofocus>
              </div>
              <div class="floating-field">
                  <label for="last_name" class="fl-label">Last Name</label>
                  <input class="input-field" type="text" id="last_name" name="last_name" required value="{{ last_name or '' }}" autocomplete="family-name">
              </div>
            </div>
            <div class="floating-field">
                <label for="email" class="fl-label">Email</label>
                <input class="input-field" type="email" id="email" name="email" required value="{{ email or '' }}" autocomplete="email">
                <div id="email-feedback" class="muted small" style="display:none; color:var(--danger, #d9534f); margin-top:6px;">Enter a valid email address</div>
            </div>
            <div class="floating-field">
                <label for="password" class="fl-label">Password</label>
                <input class="input-field" type="password" id="password" name="password" required autocomplete="new-password">
            </div>
            <div class="floating-field">
                <label for="password_confirm" class="fl-label">Confirm password</label>
                <input class="input-field" type="password" id="password_confirm" name="password_confirm" required autocomplete="new-password">
                <div id="confirm-feedback" class="muted small" style="display:none; color:var(--danger, #d9534f); margin-top:6px;">Passwords do not match.</div>
            </div>
            <div class="password-policy" id="password-policy" style="display:none;">
                <p class="policy-title">Password must contain:</p>
                <ul class="policy-list" id="policy-list">
                    <li id="length-check" class="policy-item">At least 8 characters</li>
                    <li id="number-check" class="policy-item">At least 1 number</li>
                    <li id="capital-check" class="policy-item">At least 1 capital letter</li>
                    <li id="special-check" class="policy-item">At least 1 special character</li>
                </ul>
            </div>
            {% if error %}
            {{ notice(error, 'error') }}
            {% endif %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
            <input type="hidden" name="captcha_token" value="">
            {% set text = "Sign up" %}
            {% set class = "btn primary block" %}
            {% set type = "submit" %}
            {% include "components/button.html" %}
        </form>
    <div class="section text-center" style="margin-top:12px;">
        <span class="muted">Already have an account?</span>
        <a class="btn" href="/login">Log in</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const passwordPolicy = document.getElementById('password-policy');
    const policyList = document.getElementById('policy-list');
    const checks = [
        { id: 'length-check', test: pwd => pwd.length >= 8 },
        { id: 'number-check', test: pwd => /\d/.test(pwd) },
        { id: 'capital-check', test: pwd => /[A-Z]/.test(pwd) },
        { id: 'special-check', test: pwd => /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd) }
    ];

    function updatePolicy() {
        const pwd = passwordInput.value;
        let unmet = 0;
        checks.forEach(({id, test}) => {
            const el = document.getElementById(id);
            if (!test(pwd)) {
                el.style.display = '';
                unmet++;
            } else {
                el.style.display = 'none';
            }
        });
        // Hide the whole policy if all are met
        passwordPolicy.style.display = (pwd && unmet > 0) ? '' : 'none';
    }

    passwordInput.addEventListener('focus', function() {
        updatePolicy();
    });
    passwordInput.addEventListener('input', function() {
        updatePolicy();
    });
    passwordInput.addEventListener('blur', function() {
        setTimeout(() => { passwordPolicy.style.display = 'none'; }, 100);
    });

    // Email live validation
    const emailInput = document.getElementById('email');
    const emailFeedback = document.getElementById('email-feedback');
    function validateEmail(value){
        if (!value) return false;
        // simple RFC-like check
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(value);
    }
    if (emailInput){
        emailInput.addEventListener('input', function(){
            const ok = validateEmail(emailInput.value);
            if (!ok && emailInput.value.trim() !== ''){
                emailFeedback.style.display = '';
                emailInput.setAttribute('aria-invalid','true');
            } else {
                emailFeedback.style.display = 'none';
                emailInput.removeAttribute('aria-invalid');
            }
        });
    }

    // Password confirm live check
    const passConfirm = document.getElementById('password_confirm');
    const confirmFeedback = document.getElementById('confirm-feedback');
    function validateConfirm(){
        const p = passwordInput.value || '';
        const pc = passConfirm ? passConfirm.value : '';
        const match = p === pc;
        if (passConfirm){
            if (!match && pc.length > 0){
                confirmFeedback.style.display = '';
                passConfirm.setCustomValidity('Passwords do not match');
            } else {
                confirmFeedback.style.display = 'none';
                passConfirm.setCustomValidity('');
            }
        }
    }
    if (passConfirm){
        passConfirm.addEventListener('input', validateConfirm);
        passwordInput.addEventListener('input', validateConfirm);
    }
});
</script>
{% endblock %}